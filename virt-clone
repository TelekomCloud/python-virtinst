#!/usr/bin/python -tt
#
# Copyright(c) FUJITSU Limited 2007.
#
# Script to set up an cloning guest configuration and kick off an cloning
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by 
# the Free  Software Foundation; either version 2 of the License, or 
# (at your option)  any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
# MA 02110-1301 USA.


import os, sys, string
from optparse import OptionParser, OptionValueError
import subprocess
import libxml2
import logging
import libvirt
import virtinst
import virtinst.CloneManager as clmgr

import gettext
import locale
import virtinst.cli as cli

locale.setlocale(locale.LC_ALL, '')
gettext.bindtextdomain(virtinst.gettext_app, virtinst.gettext_dir)
gettext.install(virtinst.gettext_app, virtinst.gettext_dir, unicode=1)

### General input gathering functions
def get_clone_name(new_name, design):
    while 1:
        new_name = cli.prompt_for_input(_("What is the name for the cloned virtual machine?"), new_name)
        try:
            design.clone_name = new_name
            break
        except (ValueError, RuntimeError), e:
            print _("ERROR: "), e
            new_name = None

def get_original_guest(guest, design):
    while 1:
        guest = cli.prompt_for_input(_("What is the name or uuid of the original virtual machine?"), guest)
        try:
            design.original_guest = guest
            break
        except (ValueError, RuntimeError), e:
            print _("ERROR: "), e
            guest = None

def get_clone_macaddr(new_mac, design):
    if new_mac is None:
        pass
    elif new_mac[0] == "RANDOM":
        new_mac = None
    else:
        for i in new_mac:
            design.set_clone_mac(i)

def get_clone_uuid(new_uuid, design):
    if new_uuid is not None:
        design.set_clone_uuid(new_uuid)

def get_clone_diskfile(new_diskfiles, design, conn):
    if new_diskfiles is None:
        new_diskfiles = [None]

    for i in range(0, len(new_diskfiles)):
        disk = new_diskfiles[i]
        while 1:
            disk = cli.prompt_for_input(_("What would you like to use as the cloned disk (file path)?"), disk)

            # Build disk object for validation
            try:
                d = virtinst.VirtualDisk(path=disk, size=0)
            except ValueError, e:
                print _("ERROR: "), e
                disk = None
                continue

            # Check disk conflicts
            if d.is_conflict_disk(conn) is True:
                warnmsg = _("Disk %s is already in use by another guest!\n") % d.path
                if not cli.prompt_for_yes_or_no(warnmsg + _("Do you really want to use the disk (yes or no)? ")):
                    disk = None
                    continue
            new_diskfiles[i] = d.path
            break

    for i in new_diskfiles:
        design.set_clone_devices(i)

def get_clone_sparse(sparse, design):
    design.set_clone_sparse(sparse)

def get_preserve(preserve, design):
    design.set_preserve(preserve)


def get_force_target(target, design):
    if target is None:
        pass
    else:
        for i in target:
            design.set_force_target(i)

def parse_args():
    parser = cli.VirtOptionParser()

    # original name
    parser.add_option("-o", "--original", type="string", dest="original_guest",
                      action="callback", callback=cli.check_before_store,
                      help=_("Name or uuid for the original guest; The status must be shut off"))
    # clone new name
    parser.add_option("-n", "--name", type="string", dest="new_name",
                      action="callback", callback=cli.check_before_store,
                      help=_("Name for the new guest"))

    # clone new uuid
    parser.add_option("-u", "--uuid", type="string",
                      dest="new_uuid", action="callback", callback=cli.check_before_store,
                      help=_("New UUID for the clone guest; Default is a randomly generated UUID"))

    # clone new macs
    parser.add_option("-m", "--mac", type="string",
                      dest="new_mac", action="callback", callback=cli.check_before_append,
                      help=_("New fixed MAC address for the clone guest. Default is a randomly generated MAC"))

    # clone new disks 
    parser.add_option("-f", "--file", type="string",
                      dest="new_diskfile", action="callback", callback=cli.check_before_append,
                      help=_("New file to use as the disk image for the new guest"))
    # connect
    parser.add_option("", "--connect", type="string",
                      dest="connect", action="callback", callback=cli.check_before_store,
                      help=_("Connect to hypervisor with URI"),
                      default=virtinst.util.default_connection())

    # target
    parser.add_option("", "--force-copy", type="string",
                      dest="target", action="callback", callback=cli.check_before_append,
                      help=_("Force to copy devices (eg, if 'hdc' is a readonly cdrom device, --force-copy=hdc)"))

    # non sparse
    parser.add_option("", "--nonsparse", action="store_false",
                      default=True, dest="sparse",
                      help=_("Do not use a sparse file for the clone's disk image"))

    # preserve
    parser.add_option("", "--preserve-data", action="store_false",
                      default=True, dest="preserve",
                      help=_("Preserve a new file to use as the disk image for the new guest"))

    # Misc options
    parser.add_option("-d", "--debug", action="store_true", dest="debug",
                      help=_("Print debugging information"))
    parser.add_option("", "--force", action="store_true", dest="force",
                      help=_("Do not prompt for input. Answers yes where applicable, terminates for all other prompts"),
                      default=False)

    (options,args) = parser.parse_args()
    return options

### Let's do it!
def main():
    options = parse_args()

    cli.setupLogging("virt-clone", options.debug)
    cli.set_force(options.force)

    logging.debug("start clone with HV " + options.connect)

    if options.connect is None or options.connect.lower()[0:3] == "xen":
        if os.geteuid() != 0:
            print >> sys.stderr, _("Must be root to clone Xen guests")
            sys.exit(1)

    conn = cli.getConnection(options.connect)
    design = clmgr.CloneDesign(connection=conn)

    try:
        get_clone_diskfile(options.new_diskfile, design, conn)
        get_clone_macaddr(options.new_mac, design)
        get_original_guest(options.original_guest, design)
        get_clone_name(options.new_name, design)
        get_clone_uuid(options.new_uuid, design)
        get_clone_sparse(options.sparse, design)
        get_force_target(options.target, design)
        get_preserve(options.preserve, design)

        # setup design object
        design.setup()

        # start cloning
        clmgr.start_duplicate(design)

        logging.debug("end clone")
    except RuntimeError, e:
        print >> sys.stderr, _("ERROR: "), e
        sys.exit(1)
    except SystemExit, e:
        sys.exit(e.code)
    except Exception, e:
        print "ERROR: ", e
        sys.exit(1)

if __name__ == "__main__":
    try:
        main()
    except SystemExit, e:
        sys.exit(e.code)
    except KeyboardInterrupt, e:
        print >> sys.stderr, _("Installation aborted at user request")
    except Exception, e:
        logging.exception(e)
        sys.exit(1)

